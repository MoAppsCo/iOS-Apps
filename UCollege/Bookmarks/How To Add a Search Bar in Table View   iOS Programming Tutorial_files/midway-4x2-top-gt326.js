DISQUS.addBlocks("theme")(function(c){c.blocks.discoveryBoxHelp=function(i,d){var a=new c.Builder,f=DISQUS.extend({},i,d);with(f)return a.put('    <div class="alert">        <a class="close" data-action="discovery-help-close"/>\u00d7</a>        '),a.put(c.interpolate(gettext("Disqus helps you find new and interesting content, discussions and products. Some sponsors and ecommerce sites may pay us for these recommendations and links. %(learnMore)s or %(feedback)s."),{learnMore:c.renderBlock("learnMore"),
feedback:c.renderBlock("feedback")})),a.put("    </div>"),a.compile()};c.blocks.feedback=function(i,d){var a=new c.Builder,f=DISQUS.extend({},i,d);with(f)return a.put('<a href="https://www.surveymonkey.com/s/GHK872T" target="_blank">    '),a.put(gettext("give us feedback")),a.put("</a>"),a.compile()};c.blocks.relatedThread=function(i,d){var a=new c.Builder,f=DISQUS.extend({},i,d);with(f)return a.put('    <li class="discovery-unit">        <div class="main publisher-anchor-color">            <h3 title="'),
a.put((a.esc||function(a){return a})(thread.title)),a.put('">                <a class="title"                href="'),a.put((a.esc||function(a){return a})(thread.redirectUrl)),a.put('"                '),external&&a.put('target="_blank"'),a.put(">"),a.put(thread.title),a.put("</a>            </h3>            "),external&&thread.forum&&thread.forum.name&&(a.put('            <span class="extra eo">'),a.put((a.esc||function(a){return a})(thread.forum.name)),a.put("</span>            ")),a.put('            <span class="extra">            '),
thread.posts?(a.put("                "),thread.posts===1?(a.put("                    "),a.put(gettext("1 comment"))):(a.put("                    "),a.put(c.interpolate(gettext("%(numPosts)s comments"),{numPosts:thread.posts}))),a.put("                ")):(a.put("                "),a.put((a.esc||function(a){return a})(thread.brand))),a.put("            "),a.put("            </span>        </div>    </li>"),a.compile()};c.blocks.learnMore=function(i,d){var a=new c.Builder,f=DISQUS.extend({},i,d);with(f)return a.put('<a href="http://help.disqus.com/customer/portal/articles/666278-introducing-promoted-discovery-and-f-a-q-"   target="_blank">'),
a.put(gettext("Learn more")),a.put("</a>"),a.compile()};c.blocks.relatedThreads=function(i,d){var a=new c.Builder,f=DISQUS.extend({},i,d);with(f)return a.put('<div id="discovery-main" class="extra-links">    <div id="discovery-note" style="display:none;">        '),function(){var g={};c.extend(g,d);c.extend(g,{});a.put(c.renderBlock("discoveryBoxHelp",g))}(),a.put('    </div>    <div id="discovery-content-wrap">        <section id="discovery-external">            <header>                <div id="discovery-options">                    <span class="publisher-anchor-color"><a href="#" id="discovery-help" data-action="discovery-help">'),
a.put(gettext("What's this?")),a.put("</a></span>                    "),a.put("                </div>                <h2>"),a.put(gettext("Around the Web")),a.put("</h2>            </header>            <ul>                "),a.put('            </ul>        </section>        <section id="discovery-internal">            <header>                <h2>'),a.put(c.interpolate(gettext("Also on %(forumName)s"),{forumName:c.renderBlock("forumName",forum)})),a.put("</h2>            </header>            <ul>                "),
a.put("            </ul>        </section>    </div></div>"),a.compile()};c.blocks.forumName=function(i,d){var a=new c.Builder,f=DISQUS.extend({},i,d);with(f)return a.put("<strong>"),a.put((a.esc||function(a){return a})(name)),a.put("</strong>"),a.compile()}});
(function(c){var i=c.document,d=c.DISQUS;d.registerActions=function(){d.define("discovery.collections",function(){var a=!1;return{load:function(f,g){var e=d.discovery.collections;if(a)return e;var b=Backbone.Collection.extend({initialize:function(a,e){this.mainThread=e.thread;this.limit=e.limit;this.variant=e.variant||{};this.external=e.external},fetch:function(a){var e={};e.data={thread:this.mainThread.get("id")};e.parse=!1;_.extend(e,a);Backbone.Collection.prototype.fetch.call(this,e)},addBandit:function(a){if((a=
a.response)&&a.bandit)this.bandit=a.bandit},getBanditJSON:_.memoize(function(){return d.JSON.stringify(this.bandit)}),makeRedirect:function(a,e,l){var b=a?"http://redirect.disqus.com/url":e.link+"#redirect",a={url:a,imp:d.juggler.impId,zone:l.external?"external_discovery":"internal_discovery",forum:this.mainThread.get("forum").id,source_thread_id:this.mainThread.id};this.variant.isExperiment&&_.extend(a,{variant:this.variant.name});e.advertisement_id?_(a).extend({zone:"promoted_discovery",advertisement_id:e.advertisement_id,
body_id:e.body_id}):_(a).extend({thread:e.id});this.bandit&&_.extend(a,{bandit:this.getBanditJSON()});return d.serialize(b,a)}});e.RelatedThreadCollection=b.extend({model:f.RelatedThread,url:d.api.getURL("discovery/listRelated.json"),parse:function(a){this.addBandit(a);var e=[],b=a.response||[];if(b.results)b=b.results;var f=g.log,u=this.mainThread.get("forum");f(this.url,"results (",b.length,"):",b,"ids:",_.pluck(b,"id"));for(var c=0,i=b.length;c<i&&e.length<this.limit;c++)if(a=b[c].thread||b[c],
!d.debug&&a.id==this.mainThread.id)f("Thread",a.id,"is same as source thread.");else if(!d.debug&&a.posts===0)f("Thread",a.id,"does not have any comments.");else if(!d.debug&&a.title.indexOf("http://")===0)f("Thread",a.id,"has a title that starts with http.");else{a.score={score:b[c].score,k:b[c].k};if(a.signedUrl)a.redirectUrl=this.makeRedirect(a.signedUrl,a,{external:a.forum.id!=u.id});e.push(a)}f("Total results after pruning:",e.length);return e}});e.AdvertisementCollection=b.extend({model:f.Advertisement,
url:d.api.getURL("discovery/listPromoted.json"),external:!0,parse:function(a){this.addBandit(a);var e=[],b=a.response||[];if(b.results)b=b.results;g.log(this.url,"results (",b.length,"):",b,"ad_ids:",_.pluck(b,"advertisement_id"));for(var d=0,f=b.length;d<f&&e.length<this.limit;d++)a=b[d],a.redirectUrl=this.makeRedirect(a.signedUrl,a,{external:!0}),e.push(a);return e}});a=!0;return e}}});d.define("discovery.views",function(){var a=!1;return{load:function(f){var c=d.discovery.views;if(a)return c;c.RelatedThreadView=
Backbone.View.extend({events:{"click [data-redirect]":"swapLink"},dtplBlock:"relatedThread",swapLink:function(a){a=a.target||a.srcElement;a.tagName.toUpperCase()=="A"&&a.getAttribute("data-redirect")||(a=$(a).closest("a[data-redirect]")[0]);var b=a;b.setAttribute("data-href",b.getAttribute("href"));b.setAttribute("href",b.getAttribute("data-redirect"));_.delay(function(){b.setAttribute("href",b.getAttribute("data-href"))},100)},renderAvatar:function(a){var b=this.$el.find("[data-role=discovery-avatar]");
b.attr("src",a.avatar.cache);b.attr("alt",this.authorName(a));return this},authorName:function(a){return a.name||a.username},render:function(a){var a=a||{},b=a.parent,c=this.model.toJSON();if(!_.isObject(c.forum)&&_.isString(c.forum))c.forum={name:c.forum};this.setElement(d.renderBlock(this.dtplBlock,{thread:c,external:!!a.external,variant:this.model.collection.variant.name}));b.append(this.$el);f.lineTruncate(this.$el.find("h3 a.title"),{lines:2,ellipsis:!0});this.$el.find("h3, .extra").css({display:"inline"});
return this}});c.RelatedThreadCollectionView=Backbone.View.extend({resize:_.debounce(function(){this.trigger("resize")},500),render:function(a){var a=a||{},b=a.limit,d=_.isNumber(b),f=a.start,i=_.isNumber(f);this.collection.each(function(a,e){d&&e>=b||i&&e<f||(new c.RelatedThreadView({model:a})).on("resize",this.resize,this).render({parent:this.$el.find("ul"),external:!!this.collection.external})},this);return this}});c.AdvertisementCollectionView=Backbone.View.extend({render:function(a){var a=a||
{},b=a.limit,d=_.isNumber(b);this.collection.each(function(a,e){d&&e>=b||(new c.RelatedThreadView({model:a})).render({parent:this.$el.find("ul"),external:!0})},this);return this}});c.MainView=Backbone.View.extend({dtplBlock:"relatedThreads",events:{"click [data-action=discovery-close]":"close","click [data-action=discovery-help]":"showHelp","click [data-action=discovery-help-close]":"closeHelp"},close:function(a){a.preventDefault();this.remove();this.trigger("resize",0)},showHelp:function(a){a.preventDefault();
$(a.currentTarget).hide();this.$el.find("#discovery-note").show();this.trigger("resize")},closeHelp:function(a){a&&a.preventDefault();this.$el.find("#discovery-note").hide();this.trigger("resize")},renderHelp:function(a){this.closeHelp();this.$el.find("[data-action=discovery-help]").show();this.$el.find("#discovery-note").html(d.renderBlock("discoveryBoxHelp",{session:a.toJSON()}))},render:function(){this.$el.css({position:"static",visibility:"visible"});return this}});a=!0;return c}}});d.define("discovery.models",
function(){var a=!1;return{load:function(){var c=d.discovery.models;if(a)return c;var g=c.Thread=Backbone.Model.extend({defaults:{author:null,category:null,createdAt:null,forum:null,identifiers:[],ipAddress:null,isClosed:!1,isDeleted:!1,link:null,message:null,slug:null,title:null,userSubscription:!1,posts:0,reactions:0,likes:0,dislikes:0,userScore:0},url:d.api.getURL("threads/details"),parse:function(a){return a.response}});c.RelatedThread=g.extend({defaults:_.defaults({redirectUrl:null,topComment:null},
g.prototype.defaults)});c.Advertisement=Backbone.Model.extend({idAttribute:"body_id",defaults:{brand:"",headline:"",text:"",url:"",advertisement_id:null,body_id:null,redirectUrl:null},get:function(a){if(a==="title")return this.get("headline");return Backbone.Model.prototype.get.call(this,a)},toJSON:function(){var a=this.attributes;return{title:a.headline,brand:a.brand,redirectUrl:a.redirectUrl,link:a.url}}});a=!0;return c}}});d.define("discovery.helpers",function(a,c){var g=null,e=!1,b=!1,v=function(){};
a.console&&(v=function(){b&&(a.console.log.apply?a.console.log.apply(a.console,arguments):a.console.log(_.toArray(arguments).join(" ")))});var q=function(a){if(a===c)return b;b=!!a},l=function(a){if(a===c)return e;e=!!a},p=function(a,b,c){if(g)if(g.length)g.enabled(a)&&b();else{var d=function(){g.enabled(a)&&b();c&&g.off("reset",d)};return void g.on("reset",d)}};return{config:function(a){g=a;l(!0);p("discovery_next:logging",function(){q(!0)})},allowLog:q,ifSwitch:p,log:v,allowLineTruncate:l,lineTruncate:function(b,
c){function f(){return l.scrollHeight-l.offsetHeight>0.2*p}function g(){m.lastChild&&!_.contains(["...","\u2026"],m.lastChild.nodeValue)&&(k=m.appendChild(a.document.createTextNode(" "+r)),f()&&(m.removeChild(k),m.removeChild(m.lastChild),g()))}if(e){var n=d.logError||function(){};if(!b.closest("body").length)return void n("lineTruncate called on el not on DOM");if(b.text().length<1)return void n("lineTruncated called on empty el");if(_.any(b.children(),function(a){return a.nodeType!==3}))return void n("lineTruncate called on non-flat el");
var m=b[0],l=m;if(b.css("display")!=="block")for(;l.parentNode;)if(l=l.parentNode,$(l).css("display")==="block")break;var p=parseFloat(b.css("font-size"),10);if(f()){var c=c||{},n=c.lines||1,r=c.ellipsis,k,h=b.text();if(h.length){var o=b.width()/p,n=parseInt(o*n,10),h=h.split(/\s/),o=0;b.empty();for(var j=0,q=h.length;j<q;j++){o+=h[j].length+1;if(o>=n)break;m.appendChild(i.createTextNode(" "+h[j]))}if(f()){do k=m.removeChild(m.lastChild);while(f())}else{do k=m.appendChild(i.createTextNode(" "+h[j++]));
while(!f()&&j<q);m.removeChild(k)}r&&(_.isString(r)||(r="\u2026"),g())}}}}}});d.define("discovery",function(){return this.overwrites({init:function(a,c){function g(a,b,c,d,f){if(_.isNumber(d)&&a.length<d)return void e();a=new z({el:b,collection:a});a.on("resize",function(){c.trigger("resize")});a.render(f||{});c.trigger("subViewRendered")}function e(b){b=b||{};if(!y){y=!0;var c=d.juggler.client("juggler");if(c){var e={major_version:"midway",internal_organic:k.length,external_organic:h.length,promoted:o.length,
promoted_ids:d.JSON.stringify(o.pluck("advertisement_id")),display:!!b.display},f;if(w.bandit||o.bandit)f=_.extend({},w.bandit,o.bandit);f&&_.extend(e,{bandit:d.JSON.stringify(f)});a.isExperiment&&_.extend(e,{variant:p});q("Juggler init_discovery",e);c.emit("init_discovery",e);v("dark_jester",function(){d.juggler.client("jester",!0).emit("init_discovery",e)})}}}var b=d.discovery.helpers,v=b.ifSwitch,q=b.log,l=a.switches,p=a.variant,u=a.session,t=a.forum,x=a.containerId;b.config(a.switches);var s=
4,n=p.match(/(\d)x\d/);n&&(s=parseInt(n[1],10));var n=$("#"+a.loungeId),m=p.match(/^midway-4x2-top-gt(\d{1,3})$/);m&&(m=m[1],n.height()>m&&u.isAnonymous()&&t.settings.discoveryMax&&l.enabled("discovery_next:top_placement")?x+="-top":s=6);var t=d.discovery.models.load(),n=d.discovery.collections.load(t,b),b=d.discovery.views.load(b),l=n.RelatedThreadCollection,z=b.RelatedThreadCollectionView,n=n.AdvertisementCollection,A=b.AdvertisementCollectionView,r=new t.Thread(_.extend(a.thread,{forum:a.forum})),
s={thread:r,limit:s,variant:{isExperiment:!!a.isExperiment,name:p}},k=new l(null,s),h=new l(null,_.defaults({external:!0},s)),o=new n(null,_.defaults({external:!0},s)),t=[k,h,o];_.invoke(t,"on","error",e);var j=new b.MainView({el:i.getElementById(x)});j.$el.css({position:"absolute",visibility:"hidden",display:"block"});j.$el.append(d.renderBlock(j.dtplBlock,{forum:r.get("forum"),variant:p,session:u.toJSON()}));u.on("change:canModerate",_.bind(j.renderHelp,j,u));_.invoke(t,"on","reset",function(){var a=
0,b=0,d=!1;return function(e){d||(e.external?b+=e.length:a+=e.length,a<1||b<1||(d=!0,c(j)))}}());j.on("subViewRendered",_.after(2,function(){j.trigger("allSubviewsRendered");e({display:!0})}));var w=new l(null,_.defaults({limit:k.limit+h.limit},s));w.fetch({data:{thread:r.id,limit:w.limit},success:function(a){if(a.length<1)return void e();var b=r.get("forum"),c;c=a.filter(function(a){return a.get("forum").id!=b.id});a=_.difference(a.models,c);k.reset(a.slice(0,k.limit)).each(function(a){a.collection=
k});a=j.$el.find("#discovery-internal")[0];g(k,a,j,1,{start:0,limit:c.length});q("Internal organic",k.pluck("id"));h.reset(c.slice(0,h.limit)).each(function(a){a.collection=h});h.fetched=!0;q("External organic",h.pluck("id"))},error:e});o.fetch({data:{thread:r.id,limit:o.limit},success:function(a){q("Promoted:",a.pluck("advertisement_id"));var b=j.$el.find("#discovery-external")[0],c=new A({el:b,collection:a}),d=function(){h.off("reset",d);if(k.length<1)return void e();var f=Math.min(k.length,a.limit),
i=Math.min(k.limit,h.length+a.length);i>h.length&&g(k,j.$el.find("#discovery-internal")[0],j,1,{start:h.length,limit:i});h.length>0?(c.render({limit:f-1}),g(h,b,j,1-a.length,{limit:Math.max(f-a.length,1)})):c.render({limit:f});a.length>=1&&j.trigger("subViewRendered")};if(h.fetched)d();else h.on("reset",d)},error:e});var y=!1}})})};d.runThemeScript=d.registerActions})(this);